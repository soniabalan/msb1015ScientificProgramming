---
title: "Birds in Romania - 2 Visualization"
author: "Sonia Balan"
date: "2023-09/10"

Data Info:
  Username: soniaa.balan
  Format: SIMPLE_CSV
  Download key: 0018307-230828120925497
  Created: 2023-09-16T09:31:59.821+00:00
  Citation Info:  
    Please always cite the download DOI when using this data.
    https://www.gbif.org/citation-guidelines
    DOI: 10.15468/dl.y8qsxq
    Citation:
    GBIF Occurrence Download https://doi.org/10.15468/dl.y8qsxq Accessed from R via rgbif(https://github.com/ropensci/rgbif) on 2023-09-16

---
# Setup
```{r}
# install.packages("ggplot2")
# install.packages("dplyr")
# install.packages("sf")
# install.packages("ggmap")
# install.packages("gridExtra")
# install.packages("RColorBrewer")
# install.packages("vegan")
# install.packages("abdiv")
# install.packages("jpeg")


library(ggplot2)
library(dplyr)
library(sf)
library(gridExtra)
library(ggmap)
library(RColorBrewer)
library(vegan)
library(rstudioapi)
library(jpeg)

# load custom functions
source("Custom_functions.R")

# load data from file
data_vis <- read.csv("data_clean.csv",
                 header=TRUE,
                 stringsAsFactors=TRUE)
data_vis$eventDate <- as.Date(data_vis$eventDate)

'HOTFIX'
column_index <- which(colnames(data_vis) == "stateProvince.stateProvince")
colnames(data_vis)[column_index] <- "stateProvince"

setwd(dirname(rstudioapi::getSourceEditorContext()$path))
```
# Diagnostics Plots -------------------------------
  Cutoff Decision
```{r}
threshold = as.Date("2013-01-01") %>% format('%Y')
occurrences_per_year_complete <- ggplot(data_vis,aes(eventDate %>% format('%Y'))) +
  geom_bar(fill = "palegreen4") +
  geom_vline(xintercept = threshold,
             linewidth = 1,
             color = "royalblue4") +
  scale_x_discrete(breaks = seq(1873, 2023, by = 5)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Nr. Occurrences per Year - Complete Dataset", 
       x = "Occurrences (Count)",
       y = "Year")

# occurrences_per_year_complete
ggsave( "Figures/occurrences_per_year_complete.png",
  plot = last_plot(),
  device = "png",
  width = 10, height = 4)
```

# per time
```{r}
# ---------------
data_vis <-data_vis %>%
  filter(eventDate >= as.Date("2013-01-01"))

# Occurences per time unit ------
# nr of occurences/year
occurrences_per_year_filtered <- data_vis %>%
  group_by(year = eventDate %>% format('%Y')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = year,
             y = count,
             fill = count)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  labs(title = "Occurences per Year",
     x = "Year",
     y = "Occurences (Count)",
     fill = "Count")

# occurrences_per_year_filtered
ggsave( "Figures/occurrences_per_year_filtered.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# nr of occurences/month ----
occurrences_per_month <- data_vis %>%
  group_by(month = eventDate %>% format('%b')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = month,
             y = count, 
             fill = count)) +
  geom_bar(stat = "identity") +
  labs(title = paste("Occurences per Month"),
     x = "Month",
     y = "Occurences (Count)",
     fill = "Count") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  scale_x_discrete(limits = c("Jan", "Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))

# occurrences_per_month
ggsave( "Figures/occurrences_per_month.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# nr of occurences/day ----
occurrences_per_monthday <- data_vis %>%
  group_by(day = eventDate %>% format('%d')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = day,
             y = count, 
             fill = count)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  labs(title = paste("Occurences per Day"),
     x = "Day",
     y = "Occurences (Count)", 
     fill = "Count")

# occurrences_per_monthday
ggsave( "Figures/occurrences_per_monthday.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# nr of occurences/weekday
occurrences_per_weekday <- data_vis %>%
  group_by(day = eventDate %>% format('%a')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = day,
             y = count, 
             fill = count)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  labs(title = paste("Occurences per Weekday"),
     x = "Weekday",
     y = "Occurences (Count)",
     fill = "Count") +
  scale_x_discrete(limits = c("Mon","Tue","Wed","Thu","Fri","Sat","Sun"))

# occurrences_per_weekday
ggsave( "Figures/occurrences_per_weekday.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# occurences per location
```{r}
# top province -----
prov_all <- data_vis %>%
  group_by(stateProvince) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) 
prov_all <- prov_all[!is.na(prov_all$stateProvince),] # the top entry is NA
prov <- prov_all[1:10,]


occurrences_per_province_complete <- ggplot(prov_all, aes(x = reorder(stateProvince,n), 
                                                          y = n, 
                                                          fill = n)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = paste("Occurences per County"),
     x = "County",
     y = "Occurrences (Count)",
     fill = "Count")

# occurrences_per_province_complete
ggsave( "Figures/occurrences_per_province_complete.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)


occurrences_per_province_top10 <- ggplot(prov, aes(x = reorder(stateProvince,n), y = n, fill = n)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = paste("Occurences per County"),
     x = "County",
     y = "Occurrences (Count)",
     fill = "Count")

# occurrences_per_province_top10
ggsave( "Figures/occurrences_per_province_top10.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# latitude and longitude -----------
latitude_barplot <- ggplot(data_vis, aes(decimalLatitude)) +
  geom_histogram(fill = "deepskyblue3") +
  labs(title = paste("Occurences per Latitude"),
     x = "Latitude",
     y = "Occurrences (Count)")
longitude_barplot <- ggplot(data_vis, aes(decimalLongitude)) +
  geom_histogram(fill = "deepskyblue3") +
  labs(title = paste("Occurences per Longitude"),
     x = "Longitude",
     y = "Occurrences (Count)")
occurrences_per_coordinates <- grid.arrange(latitude_barplot, longitude_barplot, nrow = 2)
```

# Map View
```{r}
cities_list <- read.csv("orase.csv", stringsAsFactors = T)
cities_list = cities_list %>% select(c("X",
                                       "Y",
                                       "NUME",
                                       "JUDET",
                                       "POPULATIE..in.2002."))


# rename columns
colnames(cities_list) = c("decimalLongitude","decimalLatitude","locality","stateProvince","population")
# find the capital of each province
centers <-cities_list %>%
  group_by(stateProvince) %>%
  slice_max(population, n = 1) %>%
  ungroup() %>%
  filter(!grepl("Sectorul", locality)| is.na(locality))

top_centers <- centers[centers$stateProvince %in% prov$stateProvince, ]

# many points to plot - takes time to plot
occurrences_map <- ggplot(data_vis,
       aes(x = decimalLongitude,
           y = decimalLatitude)) + 
  geom_point(alpha = 0.01, 
             size = 0.25) +
  labs(title = "Density of Observations",
       x = "Longitude",
       y = "Latitude") +
  # xlab('Longitude') + 
  # ylab('Latitude') + 
  stat_density2d(data = data_vis, aes(fill = ..level..),
                 alpha = .75,
                 geom = "polygon") +
  scale_fill_viridis_c() +
  theme(legend.position = 'none') +
  xlim(20,30) +
  ylim(min(data_vis$decimalLatitude), max(data_vis$decimalLatitude)) +
  geom_text(data = top_centers, 
            aes(x = decimalLongitude, y = decimalLatitude, label = stateProvince),
            size = 3,
            color = "black", 
            nudge_x = 0.25,
            nudge_y = 0.25) + 
  geom_label(data = top_centers, 
             aes(x = decimalLongitude, y = decimalLatitude, label = stateProvince),
             size = 3, fill = "white",
             nudge_x = 0.25,
             nudge_y = 0.25, 
             alpha = 0.4) +
  theme(panel.background = element_blank())  

# occurrences_map
ggsave( "Figures/occurrences_map.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# Most dominant groups overall
```{r}
# top species ------
spp_total <- process_counts(data_vis, "species")
spp_top <- head(spp_total[order(spp_total$total_count, decreasing = TRUE), ], 11)
spp_top_sans1 <- spp_top[-1,]

# most abundent birds (overall)
species_abundence_top <- ggplot(spp_top,
       aes(x = reorder(species, total_count),
           y = total_count/sum(total_count),
           fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  # geom_text(aes(label=species),
  #           size=3,
  #           position = position_stack(vjust = 0)) +
  labs(title = "Top Species Overall",
     x = "Species",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))

# species_abundence_top
ggsave( "Figures/species_abundence_top.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# most abundent birds (overall), without Anser albiformis (outlier?)
species_abundance_no_albiformis <- ggplot(spp_top_sans1,
       aes(x = reorder(species, total_count),
           y = total_count/sum(total_count),
           fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  # geom_text(aes(label=species),
  #           size=3,
  #           position = position_stack(vjust = 0)) +
  labs(title = "Top Genus (without Anser albiformis)",
     x = "Species",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))
# species_abundance_no_albiformis
ggsave( "Figures/species_abundance_no_albiformis.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# top genus --------
gen_total <- process_counts(data_vis, "genus")
gen_top <- head(gen_total[order(gen_total$total_count, decreasing = TRUE), ], 12)
# most abundent birds (overall)
genus_abundance_top <- ggplot(gen_top, aes(x = reorder(genus, total_count),
                    y = total_count/sum(total_count),
                    fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start= 0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  labs(title = paste("Top Genuses Overall"),
     x = "Genus",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))
# genus_abundance_top
ggsave( "Figures/genus_abundance_top.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# most abundent birds (overall) without waxwings
gen_top_sans1 <- gen_top[-1,]
genus_abundance_no_anser <- ggplot(gen_top_sans1, aes(x = reorder(genus, total_count),
                          y = total_count/sum(total_count),
                          fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start= 0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  labs(title = paste("Top Genuses (without geese)"),
     x = "Genus",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))
# genus_abundance_no_anser
ggsave( "Figures/genus_abundance_no_anser.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# dominant groups per month
```{r}
#######
# order per month
ord_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "order")
ord_per_month_top <- ord_per_month %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

order_per_month_plot <- ggplot(ord_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Order",
       x = "Month",
       y = "Abundance (Proportion)",
       fill = "Order") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 
# order_per_month_plot
ggsave( "Figures/order_per_month_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

###### 
# families per month
fam_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "family")
fam_per_month_top <- fam_per_month %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

family_per_month_plot <- ggplot(fam_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Family",
       x = "Month",
       y = "Abundance (Proportion)",
       fill = "Family") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 
# family_per_month_plot
ggsave( "Figures/family_per_month_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

###### 
# species per month
spp_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "species")
spp_per_month_top <- spp_per_month %>%
  group_by(formatted_date) %>%
  top_n(5, total_count) %>%
  ungroup()

species_per_month_plot <- ggplot(spp_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Species",
       x = "Month",
       y = "Abundance (Proportion)", 
       fill = "Species") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 
# species_per_month_plot
ggsave( "Figures/species_per_month_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

```

# dominant groups per year
```{r}
#######
# order per month
ord_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "order")
ord_per_yr_top <- ord_per_yr %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

order_per_year_plot <- ggplot(ord_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Order",
       x = "Year",
       y = "Abundance (Proportion)",
       fill = "Order") 
# order_per_year_plot
ggsave( "Figures/order_per_year_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

###### 
# families per month
fam_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "family")
fam_per_yr_top <- fam_per_yr %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

family_per_year_plot <- ggplot(fam_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Family",
       x = "Year",
       y = "Abundance (Proportion)",
       fill = "Family") 
# family_per_year_plot
ggsave( "Figures/family_per_year_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

###### 
# species per month
spp_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "species")
spp_per_yr_top <- spp_per_yr %>%
  group_by(formatted_date) %>%
  top_n(5, total_count) %>%
  ungroup()

species_per_year_plot <- ggplot(spp_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Species",
       x = "Year",
       y = "Abundance (Proportion)",
       fill = "Species") 
# species_per_year_plot
ggsave( "Figures/species_per_year_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# Biodiversity
```{r}
ord_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "order")
fam_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "family")
spp_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "species")

# measuring diversity --------
# computing 3 diversity indices for 3 different taxonomical levels
# order
biodiv_ord <- biodiversity_indexes(ord_per_prov, "order") 
# family
biodiv_fam <- biodiversity_indexes(fam_per_prov, "family") 
# species
biodiv_spp <- biodiversity_indexes(spp_per_prov, "species")

# merging the information in a dataframe together with coordinates per province
div_per_prov <- centers %>%
  left_join(biodiv_ord, by = "stateProvince")
div_per_prov <- div_per_prov %>%
  left_join(biodiv_fam, by = "stateProvince")
div_per_prov <- div_per_prov %>%
  left_join(biodiv_spp, by = "stateProvince")
```

# Biodiversity Visualisations
```{r}
img <- readJPEG("map_of_romania.jpg")

# ORDER --------

'Species Richness'
map_order_richness_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index.x, 
                 color = richness_index.x)) +  
  labs(title = "Order Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude",
       size = "Richness Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank()) 

ggsave( "Figures/map_order_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SIMPSON INDEX'
map_order_simpson_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index.x, 
                 color = simpson_index.x)) + 
  labs(title = "Simpson Diversity Index (Order)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Simpson Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_order_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SHANON-WIENER INDEX '
map_order_shannon_wiener_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = shannon_wiener_index.x, 
                 color = shannon_wiener_index.x)) +  
  labs(title = "Shannon-Wiener Index (Order)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "S-W Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_order_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)


# FAMILY --------
'Species Richness'
map_family_richness_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index.y, 
                 color = richness_index.y)) +  
  labs(title = "Family Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Richness Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_family_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SIMPSON INDEX'
map_family_simpson_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index.y, 
                 color = simpson_index.y)) +  
  labs(title = "Simpson Diversity Index (Family)", 
       x = "Decimal Longitude", 
       y = "Decimal Latitude",       
       size = "Simpson Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_family_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SHANON-WIENER INDEX '
map_family_shannon_wiener_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = shannon_wiener_index.y, 
                 color = shannon_wiener_index.y)) + 
  labs(title = "Shannon-Wiener Index (Family)", 
       x = "Decimal Longitude", 
       y = "Decimal Latitude",       
       size = "S-W Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_family_shannon_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SPECIES'
# SPECIES --------
'Species Richness'
map_species_richness_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index, 
                 color = richness_index)) +  
  labs(title = "Species Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Richness Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_species_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SIMPSON INDEX'
map_species_simpson_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index, 
                 color = simpson_index)) +  
  labs(title = "Simpson Diversity Index (Species)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Simpson Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_species_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

'SHANON-WIENER INDEX '

map_species_shannon_wiener_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) + 
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) + 
  geom_point(aes(size = shannon_wiener_index, 
                 color = shannon_wiener_index)) + 
  labs(title = "Shannon-Wiener Index (Species)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "S-W Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_species_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)


```

Correlation between diversity score and nr of observations - verify robustness
```{r}
prov_biodiversity <- biodiv_spp

n <- data_vis[data_vis$stateProvince %in% biodiv_spp$stateProvince, ] %>%
  group_by(stateProvince) %>%
  summarize(n = n())

prov_biodiversity <- merge(prov_biodiversity, n, by = 'stateProvince')
prov_biodiversity <- prov_biodiversity[!is.na(prov_biodiversity$stateProvince), ]
# counts ----
# counts vs. richness index
counts_vs_richness_index <- ggplot(prov_biodiversity, aes(x = n, y = richness_index)) + 
  geom_point() +  
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 10) + 
  labs(title = "Correlation between Total Counts and Species Richness",
       x = "Total Occurrences",
       y = "Richness Index")

ggsave( "Figures/counts_vs_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# counts vs. simpson index
counts_vs_simpson_index <- ggplot(prov_biodiversity, aes(x = n, y = simpson_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 0.03) +
  labs(title = "Correlation between Total Counts and Simpson Diversity",
       x = "Total Occurrences",
       y = "Simpson Index")

ggsave( "Figures/counts_vs_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# counts vs. shannon-wiener
counts_vs_shannon_wiener_index <- ggplot(prov_biodiversity, aes(x = n, y = shannon_wiener_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 0.1) +
  labs(title = "Correlation between Total Counts and Shannon-Wiener Diversity",
       x = "Total Occurrences",
       y = "Shannon-Wiener Index")

ggsave( "Figures/counts_vs_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# log counts -----
# counts vs. richness index
log_counts_vs_richness_index <- ggplot(prov_biodiversity, aes(x = log(n), y = richness_index)) + 
  geom_point() +  
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 10) + 
  labs(title = "Correlation between Total Counts and Species Richness",
       x = "Log (Total Occurrences)",
       y = "Richness Index")

ggsave( "Figures/log_counts_vs_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# counts vs. simpson index
log_counts_vs_simpson_index <- ggplot(prov_biodiversity, aes(x = log(n), y = simpson_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 0.03) +
  labs(title = "Correlation between Total Counts and Simpson Diversity",
       x = "Log (Total Occurrences)",
       y = "Simpson Index")

ggsave( "Figures/log_counts_vs_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# counts vs. shannon-wiener
log_counts_vs_shannon_wiener_index <- ggplot(prov_biodiversity, aes(x = log(n), y = shannon_wiener_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 0.1) +
  labs(title = "Correlation between Total Counts and Shannon-Wiener Diversity",
       x = "Log (Total Occurrences)",
       y = "shannon-wiener index")

ggsave( "Figures/log_counts_vs_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)


corr_matrix <- cor(prov_biodiversity[c("richness_index", "simpson_index", "shannon_wiener_index", "n")])
print(corr_matrix)
```

# Yearly change in biodiversity
```{r}
# measuring diversity --------
# ORDER
ord_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")),"formatted_date", "stateProvince", "order")

biodiv_yearly_order <- biodiversity_indexes_yearly(ord_per_year_per_prov,"order")

# FAMILU
fam_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "stateProvince", "family")

biodiv_yearly_family <- biodiversity_indexes_yearly(fam_per_year_per_prov,"family")


# SPECIES
spp_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "stateProvince", "species")

biodiv_yearly_species <- biodiversity_indexes_yearly(spp_per_year_per_prov,"species")
```

# yearly biodiversity visualization
```{r}
# richness index -----
# Order level
distribution_order_richness_index <- ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "lightgoldenrod1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Richness Index Over Time (Order level)",
       x = "Year",
       y = "Richness Index") 

ggsave( "Figures/distribution_order_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Family level
distribution_family_richness_index <- ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "skyblue",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Richness Index Over Time (Family level)",
       x = "Year",
       y = "Richness Index") 

ggsave( "Figures/distribution_family_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

distribution_species_richness_index <- ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "pink1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Richness Index Over Time (Species level)",
       x = "Year",
       y = "Richness Index") 

ggsave( "Figures/distribution_species_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# simpson index ----
distribution_order_simpson_index <- ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "lightgoldenrod1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Simpson Index Over Time (Order level)",
       x = "Year",
       y = "Simpson Index") 

ggsave( "Figures/distribution_order_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

distribution_family_simpson_index <- ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "skyblue",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Simpson Index Over Time (Family level)",
       x = "Year",
       y = "Simpson Index") 

ggsave( "Figures/distribution_family_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

distribution_species_simpson_index <- ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "pink1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Simpson Index Over Time (Species level)",
       x = "Year",
       y = "Simpson Index") 

ggsave( "Figures/distribution_species_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# shannon-wiener index ----
distribution_order_shannon_wiener_index <- ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "lightgoldenrod1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Sihannon-Wiener Index Over Time (Order level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggsave( "Figures/distribution_order_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

distribution_family_shannon_wiener_index <- ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "skyblue",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Sihannon-Wiener Index Over Time (Family level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggsave( "Figures/distribution_family_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

distribution_species_shannon_wiener_index <- ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "pink1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Sihannon-Wiener Index Over Time (Species level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggsave( "Figures/distribution_species_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# dominant groups per province - based on counts
```{r}
#######
# order per stateProvince
ord_per_prov_top <- ord_per_prov %>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

order_per_province_counts <- ggplot(ord_per_prov_top[ord_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per State Province by Order",
       x = "Month",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/order_per_province_counts.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

###### 
# families per stateProvince
fam_per_prov_top <- fam_per_prov%>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

family_per_province_counts <- ggplot(fam_per_prov_top[fam_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Family",
       x = "Month",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/family_per_province_counts.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

###### 
# species per stateProvince
spp_per_prov_top <- spp_per_prov %>%
  group_by(stateProvince) %>%
  top_n(5, total_count) %>%
  ungroup()

species_per_province_counts <- ggplot(spp_per_prov_top[spp_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Species",
       x = "Month",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/species_per_province_counts.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

```

  Based on top diversity
```{r}
# top province -----
prov_biodiversity <- prov_biodiversity[order(prov_biodiversity$shannon_wiener_index, decreasing = T), ]

prov_biodiversity_top <- prov_biodiversity[1:10, ]


# color_scale <- scale_fill_gradient(low = "lightblue", high = "darkblue")
count_biodiv_top_prov_barplot <- ggplot(prov_biodiversity_top,
                                        aes(x = reorder(stateProvince,n),
                                            y = n, 
                                            fill = n)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
  labs(title = paste("Occurences per County - by Simpson Index"),
     x = "County",
     y = "Count",
     fill = "Total Occurrences")

shannon_wiener_top_prov_barplot <- ggplot(prov_biodiversity_top, 
                                          aes(x = reorder(stateProvince,shannon_wiener_index),
                                              y = shannon_wiener_index,
                                              fill = shannon_wiener_index)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
  labs(title = paste("Occurences per County - by Simpson Index"),
     x = "County",
     y = "Count",
     fill = "S-W Index")

grid.arrange(count_biodiv_top_prov_barplot, shannon_wiener_top_prov_barplot, nrow = 2) 
```

# dominant groups per province
```{r}
# order per stateProvince -----
ord_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "order")
ord_per_prov_top <- ord_per_prov %>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

order_per_province_shannon <- ggplot(ord_per_prov_top[ord_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Order (by Shannon-Wiener Index)",
       x = "Province",
       y = "Abundance (Proportion)",
       fill = "Order") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/order_per_province_shannon.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)


# families per stateProvince -----
fam_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "family")
fam_per_prov_top <- fam_per_prov%>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

family_per_province_shannon <- ggplot(fam_per_prov_top[fam_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Family (by Shannon-Wiener Index)",
       x = "Province",
       y = "Abundance (Proportion)",
       fill = "Family") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/family_per_province_shannon.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# species per stateProvince -----
spp_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "species")
spp_per_prov_top <- spp_per_prov %>%
  group_by(stateProvince) %>%
  top_n(5, total_count) %>%
  ungroup()

species_per_province_shannon <- ggplot(spp_per_prov_top[spp_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Species (by Shannon-Wiener Index)",
       x = "Province",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/family_per_province_shannon.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```





