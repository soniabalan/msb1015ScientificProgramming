---
title: "Birds in Romania - 2 Visualization"
author: "Sonia Balan"
date: "2023-09/10"

Data Info:
  Username: soniaa.balan
  Format: SIMPLE_CSV
  Download key: 0018307-230828120925497
  Created: 2023-09-16T09:31:59.821+00:00
  Citation Info:  
    Please always cite the download DOI when using this data.
    https://www.gbif.org/citation-guidelines
    DOI: 10.15468/dl.y8qsxq
    Citation:
    GBIF Occurrence Download https://doi.org/10.15468/dl.y8qsxq Accessed from R via rgbif(https://github.com/ropensci/rgbif) on 2023-09-16

---
# Setup
```{r}
# install.packages("ggplot2")
# install.packages("dplyr")
# install.packages("sf")
# install.packages("ggmap")
# install.packages("gridExtra")
# install.packages("RColorBrewer")
# install.packages("vegan")
# install.packages("abdiv")
# install.packages("jpeg")


library(ggplot2)
library(dplyr)
library(sf)
library(gridExtra)
library(ggmap)
library(RColorBrewer)
library(vegan)
# library(abdiv)
library(jpeg)

# load custom functions
source("Custom_functions.R")

# load data from file
data_vis <- read.csv("data_clean.csv",
                 header=TRUE,
                 stringsAsFactors=TRUE)
data_vis$eventDate <- as.Date(data_vis$eventDate)

'HOTFIX'
column_index <- which(colnames(data_vis) == "stateProvince.stateProvince")
colnames(data_vis)[column_index] <- "stateProvince"
```
# Diagnostics Plots -------------------------------
  Cutoff Decision
```{r}
# aes(x = Start.date %>% format('%Y'))
threshold = 2013 #threshold year
ggplot(data_vis,aes(eventDate %>% format('%Y'))) +
  geom_bar(fill = "#00501B") +
  geom_vline(xintercept = threshold,
             linewidth = 0.5,
             color = "black")
```
# per time
```{r}
# ---------------
data_vis <-data_vis %>%
  filter(eventDate >= as.Date("2013-01-01"))

# Occurences per time unit ------
# nr of occurences/year
ggplot(data_vis, aes(eventDate %>% format('%Y'))) +
  geom_bar(fill = "#0E6251")+
  labs(title = paste("Occurences per Year"),
     x = "Year",
     y = "Count")

# nr of occurences/month 
data_vis %>%
  group_by(month = eventDate %>% format('%b')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = month, y = count, fill = count)) +
  geom_bar(stat = "identity") +
  labs(title = paste("Occurences per Month"),
     x = "Month",
     y = "Count") +
  # scale_fill_continuous(low = "darkslategray3", high = "maroon") + 
  scale_x_discrete(limits = c("Jan", "Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))

# nr of occurences/day
ggplot(data_vis, aes(eventDate %>% format('%d'))) +
  geom_bar(fill = "#1B4F72") +
  labs(title = paste("Occurences per Day"),
     x = "Day",
     y = "Count")

# nr of occurences/weekday
ggplot(data_vis, aes(eventDate %>% format('%a'))) +
  geom_bar(fill = "#1B4F72") +
  labs(title = paste("Occurences per Weekday"),
     x = "Weekday",
     y = "Count") +
  scale_x_discrete(limits = c("Mon","Tue","Wed","Thu","Fri","Sat","Sun"))
```

# occurences per location
```{r}
# top province -----
prov <- data_vis %>%
  group_by(stateProvince) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  top_n(11,n)
prov <- prov[-1,] # the top entry is NA

# color_scale <- scale_fill_gradient(low = "lightblue", high = "darkblue")
ggplot(prov, aes(x = reorder(stateProvince,n), y = n, fill = n)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="lightgreen", high="darkblue") +
  labs(title = paste("Occurences per County"),
     x = "County",
     y = "Count")

# latitude and longitude -----------
latitude_barplot <- ggplot(data_vis, aes(decimalLatitude)) +
  geom_histogram(fill = "#1B4F72") +
  labs(title = paste("Occurences per Latitude"),
     x = "Latitude",
     y = "Count")
longitude_barplot <- ggplot(data_vis, aes(decimalLongitude)) +
  geom_histogram(fill = "#1B4F72") +
  labs(title = paste("Occurences per Longitude"),
     x = "Longitude",
     y = "Count")
grid.arrange(latitude_barplot, longitude_barplot, nrow = 2) 
```

# Map View
```{r}
cities_list <- read.csv("orase.csv", stringsAsFactors = T)
cities_list = cities_list %>% select(c("X",
                                       "Y",
                                       "NUME",
                                       "JUDET",
                                       "POPULATIE..in.2002."))


# rename columns
colnames(cities_list) = c("decimalLongitude","decimalLatitude","locality","stateProvince","population")
# find the capital of each province
centers <-cities_list %>%
  group_by(stateProvince) %>%
  slice_max(population, n = 1) %>%
  ungroup() %>%
  filter(!grepl("Sectorul", locality)| is.na(locality))

top_centers <- centers[centers$stateProvince %in% prov$stateProvince, ]

# many points to plot - takes time to plot
ggplot(data_vis,
       aes(x = decimalLongitude,
           y = decimalLatitude)) + 
  geom_point(alpha = 0.01, 
             size = 0.25) +
  # coord_equal() +
  xlab('Longitude') + 
  ylab('Latitude') + 
  stat_density2d(aes(fill = ..level..), alpha = .75,
                 geom = "polygon", data = data_vis) +
  scale_fill_viridis_c() +
  # theme(legend.position = 'none') 
  xlim(20,30) +
  ylim(min(data_vis$decimalLatitude),max(data_vis$decimalLatitude)) +
  geom_text(data = top_centers, 
            aes(x = decimalLongitude, y = decimalLatitude, label = stateProvince),
            size = 3, color = "black") + 
  geom_label(data = top_centers, 
             aes(x = decimalLongitude, y = decimalLatitude, label = stateProvince),
             size = 3, fill = "white", alpha = 0.4) +
  theme(panel.background = element_blank())  
```

# Most dominant groups overall
```{r}
# top species ------
spp_total <- process_counts(data_vis, "species")
spp_top <- head(spp_total[order(spp_total$total_count, decreasing = TRUE), ], 11)
spp_top_sans1 <- spp_top[-1,]

# most abundent birds (overall)
ggplot(spp_top,
       aes(x = reorder(species, total_count),
           y = total_count/sum(total_count),
           fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_continuous(low="lightgreen", high="darkblue") +
  labs(title = paste("Top Species Overall"),
     x = "Species",
     y = "Abundance")

# most abundent birds (overall), without Anser albiformis (outlier?)
ggplot(spp_top_sans1,
       aes(x = reorder(species, total_count),
           y = total_count/sum(total_count),
           fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_continuous(low="lightgreen", high="darkblue") +
  labs(title = paste("Top Species (without Anser albiformis)"),
     x = "Species",
     y = "Abundance")

# top genus --------
gen_total <- process_counts(data_vis, "genus")
gen_top <- head(gen_total[order(gen_total$total_count, decreasing = TRUE), ], 12)
# most abundent birds (overall)
ggplot(gen_top, aes(x = reorder(genus, total_count),
                    y = total_count/sum(total_count),
                    fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  labs(title = paste("Top Genuses Overall"),
     x = "Genus",
     y = "Abundance")
# most abundent birds (overall) without waxwings
gen_top_sans1 <- gen_top[-1,]
ggplot(gen_top_sans1, aes(x = reorder(genus, total_count),
                          y = total_count/sum(total_count),
                          fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  labs(title = paste("Top Genuses (without ducks)"),
     x = "Genus",
     y = "Abundance")
```
# dominant groups per month
```{r}
#######
# order per month
ord_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "order")
ord_per_month_top <- ord_per_month %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(ord_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Order",
       x = "Month",
       y = "Abundance (Proportion)") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_fill_viridis_d()


###### 
# families per month
fam_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "family")
fam_per_month_top <- fam_per_month %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(fam_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Family",
       x = "Month",
       y = "Abundance (Proportion)") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_fill_viridis_d()

###### 
# species per month
spp_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "species")
spp_per_month_top <- spp_per_month %>%
  group_by(formatted_date) %>%
  top_n(5, total_count) %>%
  ungroup()

ggplot(spp_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Species",
       x = "Month",
       y = "Abundance (Proportion)") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_fill_viridis_d()

```
# dominant groups per year
```{r}
#######
# order per month
ord_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "order")
ord_per_yr_top <- ord_per_yr %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(ord_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Order",
       x = "Year",
       y = "Abundance (Proportion)") +
  # scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_fill_viridis_d()


###### 
# families per month
fam_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "family")
fam_per_yr_top <- fam_per_yr %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(fam_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Family",
       x = "Year",
       y = "Abundance (Proportion)") +
  # scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_fill_viridis_d()

###### 
# species per month
spp_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "species")
spp_per_yr_top <- spp_per_yr %>%
  group_by(formatted_date) %>%
  top_n(5, total_count) %>%
  ungroup()

ggplot(spp_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Species",
       x = "Year",
       y = "Abundance (Proportion)") +
  # scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_fill_viridis_d()

```

# Biodiversity
```{r}
ord_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "order")
fam_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "family")
spp_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "species")

# measuring diversity --------
# computing 3 diversity indices for 3 different taxonomical levels
# order
biodiv_ord <- biodiversity_indexes(ord_per_prov, "order") 
# family
biodiv_fam <- biodiversity_indexes(fam_per_prov, "family") 
# species
biodiv_spp <- biodiversity_indexes(spp_per_prov, "species")

# merging the information in a dataframe together with coordinates per province
div_per_prov <- centers %>%
  left_join(biodiv_ord, by = "stateProvince")
div_per_prov <- div_per_prov %>%
  left_join(biodiv_fam, by = "stateProvince")
div_per_prov <- div_per_prov %>%
  left_join(biodiv_spp, by = "stateProvince")
```

# Biodiversity Visualisations
```{R}
img <- readJPEG("map_of_romania.jpg")

# ORDER --------

'Species Richness'
ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index.x, 
                 color = richness_index.x)) +  
  labs(title = "Order Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SIMPSON INDEX'
ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index.x, 
                 color = simpson_index.x)) + 
  labs(title = "Simpson Diversity Index (Order)",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SHANON-WIENER INDEX '
ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = shannon_wiener_index.x, 
                 color = shannon_wiener_index.x)) +  
  labs(title = "Shannon-Wiener Index (Order)",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  


# FAMILY --------
'Species Richness'
ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index.y, 
                 color = richness_index.y)) +  
  labs(title = "Family Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SIMPSON INDEX'
ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index.y, 
                 color = simpson_index.y)) +  
  labs(title = "Simpson Diversity Index (Family)", 
       x = "Decimal Longitude", 
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SHANON-WIENER INDEX '
ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = shannon_wiener_index.y, 
                 color = shannon_wiener_index.y)) + 
  labs(title = "Shannon-Wiener Index (Family)", 
       x = "Decimal Longitude", 
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SPECIES'
# SPECIES --------
'Species Richness'
ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index, 
                 color = richness_index)) +  
  labs(title = "Species Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SIMPSON INDEX'
ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index, 
                 color = simpson_index)) +  
  labs(title = "Simpson Diversity Index (Species)",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

'SHANON-WIENER INDEX '

ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) + 
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) + 
  geom_point(aes(size = shannon_wiener_index, 
                 color = shannon_wiener_index)) + 
  labs(title = "Shannon-Wiener Index (Species)",
       x = "Decimal Longitude",
       y = "Decimal Latitude") +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  


```

Correlation between diversity score and nr of observations - verify robustness
```{r}
# counts ----
# counts vs. richness index
ggplot(prov_biodiversity, aes(x = n, y = richness_index)) + 
  geom_point() +  
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 10) + 
  labs(title = "Correlation between Total Counts and Species Richness",
       x = "total counts",
       y = "richness index")

# counts vs. simpson index
ggplot(prov_biodiversity, aes(x = n, y = simpson_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 0.03) +
  labs(title = "Correlation between Total Counts and Simpson Diversity",
       x = "total counts",
       y = "simpson index")

# counts vs. shannon-wiener
ggplot(prov_biodiversity, aes(x = n, y = shannon_wiener_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 0.1) +
  labs(title = "Correlation between Total Counts and Shannon-Wiener Diversity",
       x = "total counts",
       y = "shannon-wiener index")

# log counts -----
# counts vs. richness index
ggplot(prov_biodiversity, aes(x = log(n), y = richness_index)) + 
  geom_point() +  
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 10) + 
  labs(title = "Correlation between Total Counts and Species Richness",
       x = "total counts",
       y = "richness index")

# counts vs. simpson index
ggplot(prov_biodiversity, aes(x = log(n), y = simpson_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 0.03) +
  labs(title = "Correlation between Total Counts and Simpson Diversity",
       x = "total counts",
       y = "simpson index")

# counts vs. shannon-wiener
ggplot(prov_biodiversity, aes(x = log(n), y = shannon_wiener_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 0.1) +
  labs(title = "Correlation between Total Counts and Shannon-Wiener Diversity",
       x = "total counts",
       y = "shannon-wiener index")
```

# Yearly change in biodiversity
```{r}
# measuring diversity --------
# ORDER
ord_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")),"formatted_date", "stateProvince", "order")

biodiv_yearly_order <- biodiversity_indexes_yearly(ord_per_year_per_prov,"order")

# FAMILU
fam_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "stateProvince", "family")

biodiv_yearly_family <- biodiversity_indexes_yearly(fam_per_year_per_prov,"family")


# SPECIES
spp_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "stateProvince", "species")

biodiv_yearly_species <- biodiversity_indexes_yearly(spp_per_year_per_prov,"species")
```

# yearly biodiversity visualization
```{r}
# richness index -----
# Order level
ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "goldenrod1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Richness Index Over Time (Order level)",
       x = "Year",
       y = "Richness Index") 

# Family level
ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "turquoise4",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Richness Index Over Time (Family level)",
       x = "Year",
       y = "Richness Index") 

ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "slateblue4",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Richness Index Over Time (Species level)",
       x = "Year",
       y = "Richness Index") 

# simpson index ----
ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "goldenrod1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Simpson Index Over Time (Order level)",
       x = "Year",
       y = "Simpson Index") 

ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "turquoise4",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Simpson Index Over Time (Family level)",
       x = "Year",
       y = "Simpson Index") 

ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "slateblue4",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Simpson Index Over Time (Species level)",
       x = "Year",
       y = "Simpson Index") 

# shannon-wiener index ----
ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "goldenrod1",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Sihannon-Wiener Index Over Time (Order level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "turquoise4",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Sihannon-Wiener Index Over Time (Family level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "slateblue4",
               scale = "width",
               width = 0.8) +
  # stat_summary(geom = "line", fun.data = "median_hilow", aes(group = 1), color = "blue") +
  labs(title = "Sihannon-Wiener Index Over Time (Species level)",
       x = "Year",
       y = "Shannon-Wiener Index") 
```

# dominant groups per province - based on counts
```{r}
#######
# order per stateProvince
ord_per_prov_top <- ord_per_prov %>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(ord_per_prov_top[ord_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per State Province by Order",
       x = "Month",
       y = "Abundance (Proportion)") +
  scale_fill_viridis_d() #+
  # theme(legend.position="none")


###### 
# families per stateProvince
fam_per_prov_top <- fam_per_prov%>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(fam_per_prov_top[fam_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Family",
       x = "Month",
       y = "Abundance (Proportion)") +
  scale_fill_viridis_d() #+
  # theme(legend.position="none")

###### 
# species per stateProvince
spp_per_prov_top <- spp_per_prov %>%
  group_by(stateProvince) %>%
  top_n(5, total_count) %>%
  ungroup()

ggplot(spp_per_prov_top[spp_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Species",
       x = "Month",
       y = "Abundance (Proportion)") +
  scale_fill_viridis_d() #+
  # theme(legend.position="none")

```

  Based on top diversity
```{r}
# top province -----
prov_biodiversity <- biodiv_spp

n <- data_vis[data_vis$stateProvince %in% biodiv_spp$stateProvince, ] %>%
  group_by(stateProvince) %>%
  summarize(n = n())

prov_biodiversity <- merge(prov_biodiversity, n, by = 'stateProvince')
prov_biodiversity <- prov_biodiversity[!is.na(prov_biodiversity$stateProvince), ]
prov_biodiversity <- prov_biodiversity[order(prov_biodiversity$shannon_wiener_index, decreasing = T), ]

prov_biodiversity_top <- prov_biodiversity[1:10, ]


# color_scale <- scale_fill_gradient(low = "lightblue", high = "darkblue")
count_biodiv_top_prov_barplot <- ggplot(prov_biodiversity_top,
                                        aes(x = reorder(stateProvince,n),
                                            y = n, 
                                            fill = n)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="lightgreen", high="darkblue") +
  labs(title = paste("Occurences per County - by Simpson Index"),
     x = "County",
     y = "Count")

shannon_wiener_top_prov_barplot <- ggplot(prov_biodiversity_top, 
                                          aes(x = reorder(stateProvince,shannon_wiener_index),
                                              y = shannon_wiener_index,
                                              fill = shannon_wiener_index)) +
  geom_bar(stat = "identity") +
  # coord_polar("y", start=0) + 
  scale_fill_continuous(low="lightgreen", high="darkblue") +
  labs(title = paste("Occurences per County - by Simpson Index"),
     x = "County",
     y = "Count")

grid.arrange(count_biodiv_top_prov_barplot, shannon_wiener_top_prov_barplot, nrow = 2) 
```
# dominant groups per province
```{r}
# order per stateProvince -----
ord_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "order")
ord_per_prov_top <- ord_per_prov %>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(ord_per_prov_top[ord_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Order",
       x = "Province",
       y = "Abundance (Proportion)") +
  scale_fill_viridis_d() #+
  # theme(legend.position="none")


# families per stateProvince -----
fam_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "family")
fam_per_prov_top <- fam_per_prov%>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

ggplot(fam_per_prov_top[fam_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Family",
       x = "Province",
       y = "Abundance (Proportion)") +
  scale_fill_viridis_d() #+
  # theme(legend.position="none")

# species per stateProvince -----
spp_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "species")
spp_per_prov_top <- spp_per_prov %>%
  group_by(stateProvince) %>%
  top_n(5, total_count) %>%
  ungroup()

ggplot(spp_per_prov_top[spp_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Species",
       x = "Province",
       y = "Abundance (Proportion)") +
  scale_fill_viridis_d() #+
  # theme(legend.position="none")

```


