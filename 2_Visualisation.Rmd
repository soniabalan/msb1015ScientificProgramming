---
title: "Birds in Romania - 2 Visualization"
author: "Sonia Balan"
date: "2023-09/10"

Data Info:
  Username: soniaa.balan
  Format: SIMPLE_CSV
  Download key: 0018307-230828120925497
  Created: 2023-09-16T09:31:59.821+00:00
  Citation Info:  
    Please always cite the download DOI when using this data.
    https://www.gbif.org/citation-guidelines
    DOI: 10.15468/dl.y8qsxq
    Citation:
    GBIF Occurrence Download https://doi.org/10.15468/dl.y8qsxq Accessed from R via rgbif(https://github.com/ropensci/rgbif) on 2023-09-16

---
# Setup
```{r}
source('0_Dependencies.R')
source("Custom_functions.R")

# set wrok environment
setwd(dirname(rstudioapi::getSourceEditorContext()$path))


# load data from file
data_vis <- read.csv("Data/data_clean.csv",
                 header=TRUE,
                 stringsAsFactors=TRUE)
data_vis$eventDate <- as.Date(data_vis$eventDate)
```

# EXPLORATORY PLOTS ---------------------------------------------------------

The following section generates several exploratory and diagnostics plots from the data.

  - Cutoff Decision: many years have only a few occurrences recorder, therefore only data from the last 10 years (2013-2023) is kept
```{r}
threshold = as.Date("2013-01-01") %>% format('%Y')
occurrences_per_year_complete <- ggplot(data_vis,aes(eventDate %>% format('%Y'))) +
  geom_bar(fill = "palegreen4") +
  geom_vline(xintercept = threshold,
             linewidth = 1,
             color = "royalblue4") +
  scale_x_discrete(breaks = seq(1873, 2023, by = 5)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Nr. Occurrences per Year - Complete Dataset", 
       x = "Occurrences (Count)",
       y = "Year")

# occurrences_per_year_complete
ggsave( "Figures/occurrences_per_year_complete.png",
  plot = last_plot(),
  device = "png",
  width = 10, height = 4)

# filter data
data_vis <-data_vis %>%
  filter(eventDate >= as.Date("2013-01-01"))
```

  - Total Occurrences Per Time: This section generates plots that show how many observations were made each year, month, day of the month and day of the week
```{r}
# Occurences per Year -----
occurrences_per_year_filtered <- data_vis %>%
  group_by(year = eventDate %>% format('%Y')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = year,
             y = count,
             fill = count)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  labs(title = "Occurences per Year",
     x = "Year",
     y = "Occurences (Count)",
     fill = "Count")

ggsave( "Figures/occurrences_per_year_filtered.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Occurrences per Month -----
occurrences_per_month <- data_vis %>%
  group_by(month = eventDate %>% format('%b')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = month,
             y = count, 
             fill = count)) +
  geom_bar(stat = "identity") +
  labs(title = paste("Occurences per Month"),
     x = "Month",
     y = "Occurences (Count)",
     fill = "Count") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  scale_x_discrete(limits = c("Jan", "Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))

ggsave( "Figures/occurrences_per_month.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Occurrences per Day of the Month -----
occurrences_per_monthday <- data_vis %>%
  group_by(day = eventDate %>% format('%d')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = day,
             y = count, 
             fill = count)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  labs(title = paste("Occurences per Day"),
     x = "Day",
     y = "Occurences (Count)", 
     fill = "Count")

ggsave( "Figures/occurrences_per_monthday.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Occurrences per Weekday -----
occurrences_per_weekday <- data_vis %>%
  group_by(day = eventDate %>% format('%a')) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = day,
             y = count, 
             fill = count)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low = "palegreen1", high = "palegreen4") + 
  labs(title = paste("Occurences per Weekday"),
     x = "Weekday",
     y = "Occurences (Count)",
     fill = "Count") +
  scale_x_discrete(limits = c("Mon","Tue","Wed","Thu","Fri","Sat","Sun"))

ggsave( "Figures/occurrences_per_weekday.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

  - Total Occurrences Per Location: This section generates plots that show how many observations were made in each province, the top 10 provinces with the highest number of observations, and per longitude and lattitude
```{r}
# Top Provinces -----
prov_all <- data_vis %>%
  group_by(stateProvince) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) 
prov_all <- prov_all[!is.na(prov_all$stateProvince),]
prov <- prov_all[1:10,]

# Occurrences per Province (all provinces) ----
occurrences_per_province_complete <- ggplot(prov_all, aes(x = reorder(stateProvince,n), 
                                                          y = n, 
                                                          fill = n)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = paste("Occurences per County"),
     x = "County",
     y = "Occurrences (Count)",
     fill = "Count")

ggsave( "Figures/occurrences_per_province_complete.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Occurrences per Province (top 10 provinces) -----
occurrences_per_province_top10 <- ggplot(prov, aes(x = reorder(stateProvince,n), y = n, fill = n)) +
  geom_bar(stat = "identity") + 
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = paste("Occurences per County"),
     x = "County",
     y = "Occurrences (Count)",
     fill = "Count")

ggsave( "Figures/occurrences_per_province_top10.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Occurrences per Longitude and Latitude
latitude_barplot <- ggplot(data_vis, aes(decimalLatitude)) +
  geom_histogram(fill = "deepskyblue3") +
  labs(title = paste("Occurences per Latitude"),
     x = "Latitude",
     y = "Occurrences (Count)")
longitude_barplot <- ggplot(data_vis, aes(decimalLongitude)) +
  geom_histogram(fill = "deepskyblue3") +
  labs(title = paste("Occurences per Longitude"),
     x = "Longitude",
     y = "Occurrences (Count)")
occurrences_per_coordinates <- grid.arrange(latitude_barplot, longitude_barplot, nrow = 2)
```
  - Additional to the Occurrence bar plots above, this section generates a map that shows each observation made at its coordinates. The density of observations is also plotted. The label for each of the provinces (the top 10 ones, as defined above) is placed at the center of each province, determined by the city with the highest population (from the data retrieved from https://github.com/romania/localitati)
```{r}
# read data about cities in Romania to identify the coordinates of centers
cities_list <- read.csv("Data/orase.csv", stringsAsFactors = T)
cities_list = cities_list %>% select(c("X",
                                       "Y",
                                       "NUME",
                                       "JUDET",
                                       "POPULATIE..in.2002."))


# rename columns
colnames(cities_list) = c("decimalLongitude","decimalLatitude","locality","stateProvince","population")
# find the capital of each province
centers <-cities_list %>%
  group_by(stateProvince) %>%
  slice_max(population, n = 1) %>%
  ungroup() %>%
  filter(!grepl("Sectorul", locality)| is.na(locality))

top_centers <- centers[centers$stateProvince %in% prov$stateProvince, ]

# Map Observation Density -----
occurrences_map <- ggplot(data_vis,
       aes(x = decimalLongitude,
           y = decimalLatitude)) + 
  geom_point(alpha = 0.01, 
             size = 0.25) +
  labs(title = "Density of Observations",
       x = "Longitude",
       y = "Latitude") +
  stat_density2d(data = data_vis, aes(fill = ..level..),
                 alpha = .75,
                 geom = "polygon") +
  scale_fill_viridis_c() +
  theme(legend.position = 'none') +
  xlim(20,30) +
  ylim(min(data_vis$decimalLatitude), max(data_vis$decimalLatitude)) +
  geom_text(data = top_centers, 
            aes(x = decimalLongitude, y = decimalLatitude, label = stateProvince),
            size = 3,
            color = "black", 
            nudge_x = 0.25,
            nudge_y = 0.25) + 
  geom_label(data = top_centers, 
             aes(x = decimalLongitude, y = decimalLatitude, label = stateProvince),
             size = 3, fill = "white",
             nudge_x = 0.25,
             nudge_y = 0.25, 
             alpha = 0.4) +
  theme(panel.background = element_blank())  

ggsave( "Figures/occurrences_map.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# MOST OBSERVED BIRDS -------------------------------------------------------

Here, we visualize which are the most common species and genera of birds in Romania
```{r}
# Find out the top most observed species
spp_total <- process_counts(data_vis, "species")
spp_top <- head(spp_total[order(spp_total$total_count, decreasing = TRUE), ], 11)
spp_top_sans1 <- spp_top[-1,]

# most abundent species (overall) -----
species_abundence_top <- ggplot(spp_top,
       aes(x = reorder(species, total_count),
           y = total_count/sum(total_count),
           fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  labs(title = "Top Species Overall",
     x = "Species",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))

ggsave( "Figures/species_abundence_top.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# most abundent species, without Anser albifrontis -----
species_abundance_no_albiformis <- ggplot(spp_top_sans1,
       aes(x = reorder(species, total_count),
           y = total_count/sum(total_count),
           fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  labs(title = "Top Species (without Anser albiformis)",
     x = "Species",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))

ggsave( "Figures/species_abundance_no_albiformis.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Finding out the top most observed genera
gen_total <- process_counts(data_vis, "genus")
gen_top <- head(gen_total[order(gen_total$total_count, decreasing = TRUE), ], 12)

# most abundent genera  -----
genus_abundance_top <- ggplot(gen_top, aes(x = reorder(genus, total_count),
                    y = total_count/sum(total_count),
                    fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start= 0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  labs(title = paste("Top Genuses Overall"),
     x = "Genus",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))

ggsave( "Figures/genus_abundance_top.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# most abundent genera, without geese -----
gen_top_sans1 <- gen_top[-1,]
genus_abundance_no_anser <- ggplot(gen_top_sans1, aes(x = reorder(genus, total_count),
                          y = total_count/sum(total_count),
                          fill = total_count/sum(total_count))) +
  geom_bar(stat = "identity") +
  coord_polar("y", start= 0) +
  scale_fill_continuous(low="lightpink1", high="lightpink4") +
  labs(title = paste("Top Genuses (without geese)"),
     x = "Genus",
     y = NULL,
     fill = "Abundance") +
  theme(panel.background = element_rect(fill = "transparent"))

ggsave( "Figures/genus_abundance_no_anser.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# DOMINANT GROUPS PER TIME

Here, we look at which species/families/genera are the most common each month and year. This is based on the number of times each bird has been seen per all observations (total_counts). In a later section, we will see this is not an indicative of diversity, but it still shows which birds are, in terms of absolute numbers, the most abundant.

  - Dominant Groups per Month
```{r}
# Order per Month ----
# Structuring the data to show the top orders by total counts per month
ord_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "order")
ord_per_month_top <- ord_per_month %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

# Plotting the order distribution in a normalized stacked barplot
order_per_month_plot <- ggplot(ord_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Order",
       x = "Month",
       y = "Abundance (Proportion)",
       fill = "Order") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 

ggsave( "Figures/order_per_month_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Families per month -----
# Performing the same operation at the family level
fam_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "family")
fam_per_month_top <- fam_per_month %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

# Producing the same plot for the family level data
family_per_month_plot <- ggplot(fam_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Family",
       x = "Month",
       y = "Abundance (Proportion)",
       fill = "Family") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 
# family_per_month_plot
ggsave( "Figures/family_per_month_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Species per Month -----
# Performing the same operation at the species level (fewer number of species are considered in the top to minimize clutter in the figure due to larger amounts of labels)
spp_per_month <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%b")), "formatted_date", "species")
spp_per_month_top <- spp_per_month %>%
  group_by(formatted_date) %>%
  top_n(5, total_count) %>%
  ungroup()

# Producing the same plot for species level data
species_per_month_plot <- ggplot(spp_per_month_top,
       aes(x = formatted_date,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Species",
       x = "Month",
       y = "Abundance (Proportion)", 
       fill = "Species") +
  scale_x_discrete(limits = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 

ggsave( "Figures/species_per_month_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

```

  - Dominant Groups per Year
  the same steps taken for the dominant groups per month are taken to visualize the dominant groups each year
```{r}
# Order per Year -----
ord_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "order")
ord_per_yr_top <- ord_per_yr %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

# plotting
order_per_year_plot <- ggplot(ord_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Order",
       x = "Year",
       y = "Abundance (Proportion)",
       fill = "Order") 

ggsave( "Figures/order_per_year_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Family per Year -----
fam_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "family")
fam_per_yr_top <- fam_per_yr %>%
  group_by(formatted_date) %>%
  top_n(8, total_count) %>%
  ungroup()

# plotting
family_per_year_plot <- ggplot(fam_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Family",
       x = "Year",
       y = "Abundance (Proportion)",
       fill = "Family") 

ggsave( "Figures/family_per_year_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Species per Year -----
spp_per_yr <- process_counts_per_feature(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "species")
spp_per_yr_top <- spp_per_yr %>%
  group_by(formatted_date) %>%
  top_n(5, total_count) %>%
  ungroup()

# plotting
species_per_year_plot <- ggplot(spp_per_yr_top,
       aes(x = formatted_date,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Year by Species",
       x = "Year",
       y = "Abundance (Proportion)",
       fill = "Species") 

ggsave( "Figures/species_per_year_plot.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# BIODIVERSITY -----------------------------------------------------------------------
In this next section different diversity metrics will be evaluated and the biodiversity profile of Romanian provinces will be evaluated according to these metrics.

  - Computing the Diversity Scores
```{r}
ord_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "order")
fam_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "family")
spp_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "species")


# computing 3 diversity indices for 3 different taxonomic levels
# order
biodiv_ord <- biodiversity_indexes(ord_per_prov, "order") 
# family
biodiv_fam <- biodiversity_indexes(fam_per_prov, "family") 
# species
biodiv_spp <- biodiversity_indexes(spp_per_prov, "species")

# merging the information in a data frame together with coordinates per province
div_per_prov <- centers %>%
  left_join(biodiv_ord, by = "stateProvince")
div_per_prov <- div_per_prov %>%
  left_join(biodiv_fam, by = "stateProvince")
div_per_prov <- div_per_prov %>%
  left_join(biodiv_spp, by = "stateProvince")
```

# Correlations between Occurrences and Diversity Indices
  - Investigating the correlational relationship between each diversity score with respect to the total number of observations (total_counts) per province, and the log of the total number of observations per province
```{r}
# Structuring a data frame to contain count and diversity information by province
prov_biodiversity <- biodiv_spp
n <- data_vis[data_vis$stateProvince %in% biodiv_spp$stateProvince, ] %>%
  group_by(stateProvince) %>%
  summarize(n = n())
prov_biodiversity <- merge(prov_biodiversity, n, by = 'stateProvince')
prov_biodiversity <- prov_biodiversity[!is.na(prov_biodiversity$stateProvince), ]

# Counts vs Richness Index -----
counts_vs_richness_index <- ggplot(prov_biodiversity, aes(x = n, y = richness_index)) + 
  geom_point() +  
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 10) + 
  labs(title = "Correlation between Total Counts and Species Richness",
       x = "Total Occurrences",
       y = "Richness Index")

ggsave( "Figures/counts_vs_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Counts vs Simpson Index -----
counts_vs_simpson_index <- ggplot(prov_biodiversity, aes(x = n, y = simpson_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 0.03) +
  labs(title = "Correlation between Total Counts and Simpson Diversity",
       x = "Total Occurrences",
       y = "Simpson Index")

ggsave( "Figures/counts_vs_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Counts vs Shannon-Wiener Index -----
counts_vs_shannon_wiener_index <- ggplot(prov_biodiversity, aes(x = n, y = shannon_wiener_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 1000,
            nudge_y = 0.1) +
  labs(title = "Correlation between Total Counts and Shannon-Wiener Diversity",
       x = "Total Occurrences",
       y = "Shannon-Wiener Index")

ggsave( "Figures/counts_vs_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Log Counts vs Richness Index -----
log_counts_vs_richness_index <- ggplot(prov_biodiversity, aes(x = log(n), y = richness_index)) + 
  geom_point() +  
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 10) + 
  labs(title = "Correlation between Total Counts and Species Richness",
       x = "Log (Total Occurrences)",
       y = "Richness Index")

ggsave( "Figures/log_counts_vs_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Log Counts vs Simpson Index -----
log_counts_vs_simpson_index <- ggplot(prov_biodiversity, aes(x = log(n), y = simpson_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 0.03) +
  labs(title = "Correlation between Total Counts and Simpson Diversity",
       x = "Log (Total Occurrences)",
       y = "Simpson Index")

ggsave( "Figures/log_counts_vs_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Log Counts vs Shannon-Wiener Index -----
log_counts_vs_shannon_wiener_index <- ggplot(prov_biodiversity, aes(x = log(n), y = shannon_wiener_index)) + 
  geom_point() +
  geom_text(data = prov_biodiversity[prov_biodiversity$stateProvince %in% prov$stateProvince, ],
            aes(label = stateProvince),
            size = 3, color = "black",
            nudge_x = 0.005,
            nudge_y = 0.1) +
  labs(title = "Correlation between Total Counts and Shannon-Wiener Diversity",
       x = "Log (Total Occurrences)",
       y = "shannon-wiener index")

ggsave( "Figures/log_counts_vs_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Correlation Matrix -----
corr_matrix <- cor(prov_biodiversity[c("richness_index", "simpson_index", "shannon_wiener_index", "n")])
print(corr_matrix)
```

# Visualize Biodiversity Scores per Province
The scores of each province are overlayed on top of a map that shows the relevant geographical features and rivers of Romania 
```{r}
img <- readJPEG("map_of_romania.jpg")

# Order Level Diversity -----
# Richness Index
map_order_richness_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index.x, 
                 color = richness_index.x)) +  
  labs(title = "Order Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude",
       size = "Richness Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank()) 
map_order_richness_index

ggsave( "Figures/map_order_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Simpson Index
map_order_simpson_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index.x, 
                 color = simpson_index.x)) + 
  labs(title = "Simpson Diversity Index (Order)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Simpson Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_order_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Shannon-Wiener Index
map_order_shannon_wiener_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = shannon_wiener_index.x, 
                 color = shannon_wiener_index.x)) +  
  labs(title = "Shannon-Wiener Index (Order)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "S-W Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_order_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)


# Family Level Diversity -----
# Richness Index
map_family_richness_index <- ggplot(data = div_per_prov, 
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index.y, 
                 color = richness_index.y)) +  
  labs(title = "Family Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Richness Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_family_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Simpson Index
map_family_simpson_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index.y, 
                 color = simpson_index.y)) +  
  labs(title = "Simpson Diversity Index (Family)", 
       x = "Decimal Longitude", 
       y = "Decimal Latitude",       
       size = "Simpson Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_family_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Shannon-Wiener Index
map_family_shannon_wiener_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = shannon_wiener_index.y, 
                 color = shannon_wiener_index.y)) + 
  labs(title = "Shannon-Wiener Index (Family)", 
       x = "Decimal Longitude", 
       y = "Decimal Latitude",       
       size = "S-W Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_family_shannon_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Species Level Diversity -----
# Richness Index
map_species_richness_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = richness_index, 
                 color = richness_index)) +  
  labs(title = "Species Richness",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Richness Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_species_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Simpson Index
map_species_simpson_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) +
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) +
  geom_point(aes(size = simpson_index, 
                 color = simpson_index)) +  
  labs(title = "Simpson Diversity Index (Species)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "Simpson Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_species_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Shannon-Wiener Index
map_species_shannon_wiener_index <- ggplot(data = div_per_prov,
       aes(x = decimalLongitude, y = decimalLatitude)) + 
  annotation_raster(img,
                    xmin = min(div_per_prov$decimalLongitude)-1.25,
                    xmax = max(div_per_prov$decimalLongitude)+2,
                    ymin = min(div_per_prov$decimalLatitude)-0.75,
                    ymax = max(div_per_prov$decimalLatitude)+1) + 
  geom_point(aes(size = shannon_wiener_index, 
                 color = shannon_wiener_index)) + 
  labs(title = "Shannon-Wiener Index (Species)",
       x = "Decimal Longitude",
       y = "Decimal Latitude",       
       size = "S-W Index",
       color = NULL) +
  xlim(min(div_per_prov$decimalLongitude)-1,
       max(div_per_prov$decimalLongitude)+0.5)+
  ylim(min(div_per_prov$decimalLatitude)-0.5,
       max(div_per_prov$decimalLatitude)+0.25)+
  geom_text(aes(x = decimalLongitude,
                y = decimalLatitude,
                label = stateProvince),
            size = 3, 
            color = "black",
            nudge_x = 0.15,
            nudge_y = 0.2) + 
  scale_color_gradient(low = "yellow", high = "purple") +
  theme(panel.background = element_blank())  

ggsave( "Figures/map_species_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

# Visualize the Yearly Change in Biodiversity
  - computing yearly biodiversity
```{r}
# Order Level
ord_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")),"formatted_date", "stateProvince", "order")

biodiv_yearly_order <- biodiversity_indexes_yearly(ord_per_year_per_prov,"order")

# Family Level
fam_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "stateProvince", "family")

biodiv_yearly_family <- biodiversity_indexes_yearly(fam_per_year_per_prov,"family")

# Species Level
spp_per_year_per_prov <- process_counts_per_feature_per_time(data_vis %>% mutate(formatted_date = format(eventDate, "%Y")), "formatted_date", "stateProvince", "species")

biodiv_yearly_species <- biodiversity_indexes_yearly(spp_per_year_per_prov,"species")
```

  - Visualization of the Distribution of Diversity Values for each Province in a Year
```{r}
# Richness Index -----
# Order level
distribution_order_richness_index <- ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "lightgoldenrod1",
               scale = "width",
               width = 0.8) +
  labs(title = "Richness Index Over Time (Order level)",
       x = "Year",
       y = "Richness Index") 

ggsave( "Figures/distribution_order_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Family level
distribution_family_richness_index <- ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "skyblue",
               scale = "width",
               width = 0.8) +
  labs(title = "Richness Index Over Time (Family level)",
       x = "Year",
       y = "Richness Index") 

ggsave( "Figures/distribution_family_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Species level
distribution_species_richness_index <- ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = richness_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "pink1",
               scale = "width",
               width = 0.8) +
  labs(title = "Richness Index Over Time (Species level)",
       x = "Year",
       y = "Richness Index") 

ggsave( "Figures/distribution_species_richness_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Simpson Index ----
# Order Level
distribution_order_simpson_index <- ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "lightgoldenrod1",
               scale = "width",
               width = 0.8) +
  labs(title = "Simpson Index Over Time (Order level)",
       x = "Year",
       y = "Simpson Index") 

ggsave( "Figures/distribution_order_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Family Level
distribution_family_simpson_index <- ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "skyblue",
               scale = "width",
               width = 0.8) +
  labs(title = "Simpson Index Over Time (Family level)",
       x = "Year",
       y = "Simpson Index") 

ggsave( "Figures/distribution_family_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Species Level
distribution_species_simpson_index <- ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = simpson_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "pink1",
               scale = "width",
               width = 0.8) +
  labs(title = "Simpson Index Over Time (Species level)",
       x = "Year",
       y = "Simpson Index") 

ggsave( "Figures/distribution_species_simpson_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Shannon-Wiener Index -----
# Order Level
distribution_order_shannon_wiener_index <- ggplot(biodiv_yearly_order, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "lightgoldenrod1",
               scale = "width",
               width = 0.8) +
  labs(title = "Sihannon-Wiener Index Over Time (Order level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggsave( "Figures/distribution_order_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Family Level
distribution_family_shannon_wiener_index <- ggplot(biodiv_yearly_family, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "skyblue",
               scale = "width",
               width = 0.8) +
  labs(title = "Sihannon-Wiener Index Over Time (Family level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggsave( "Figures/distribution_family_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)

# Species Level
distribution_species_shannon_wiener_index <- ggplot(biodiv_yearly_species, aes(x = factor(formatted_date), y = shannon_wiener_index)) +
  geom_violin (draw_quantiles = c(0.25, 0.5, 0.75),
               fill = "pink1",
               scale = "width",
               width = 0.8) +
  labs(title = "Sihannon-Wiener Index Over Time (Species level)",
       x = "Year",
       y = "Shannon-Wiener Index") 

ggsave( "Figures/distribution_species_shannon_wiener_index.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 4)
```

  - Dominant Groups per Province - based on counts
  
  Here, we look at which species/families/genera are the most common in each province. We first do this based on the provinces with the most observations (total_count), whereas in the next section the provinces with the highest Shannon-Wiener diversity index. We are interested to see the differences between these provinces.
  
  The stacked barplots will contain the relative amount of birds by total number of observations (total_counts) in both cases, just the provinces will (potentially) differ.
```{r}
# Order Level -----
ord_per_prov_top <- ord_per_prov %>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

order_per_province_counts <- ggplot(ord_per_prov_top[ord_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per State Province by Order",
       x = "Province",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/order_per_province_counts.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 6)

# Family Level ------
fam_per_prov_top <- fam_per_prov%>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

family_per_province_counts <- ggplot(fam_per_prov_top[fam_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Family",
       x = "Province",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/family_per_province_counts.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 6)

# Species Level -----
spp_per_prov_top <- spp_per_prov %>%
  group_by(stateProvince) %>%
  top_n(5, total_count) %>%
  ungroup()

species_per_province_counts <- ggplot(spp_per_prov_top[spp_per_prov_top$stateProvince %in% prov$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Month by Species",
       x = "Province",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/species_per_province_counts.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 6)
```

  - Based on Shannon-Wiener Diversity
    Obtaining the provinces with the highest diversity
```{r}
# Obtaining the most diverse 10 provinces according to the Shannon-Wiener diversity index
prov_biodiversity <- prov_biodiversity[order(prov_biodiversity$shannon_wiener_index, decreasing = T), ]

prov_biodiversity_top <- prov_biodiversity[1:10, ]

# Visualizing the number of observations in the most "observed" provinces
count_biodiv_top_prov_barplot <- ggplot(prov_biodiversity_top,
                                        aes(x = reorder(stateProvince,n),
                                            y = n, 
                                            fill = n)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
  labs(title = paste("Occurences per County - by Simpson Index"),
     x = "County",
     y = "Count",
     fill = "Total Occurrences")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


# Visualizing the number of observations in the most diverse provinces
shannon_wiener_top_prov_barplot <- ggplot(prov_biodiversity_top, 
                                          aes(x = reorder(stateProvince,shannon_wiener_index),
                                              y = shannon_wiener_index,
                                              fill = shannon_wiener_index)) +
  geom_bar(stat = "identity") +
  scale_fill_continuous(low="deepskyblue1", high="deepskyblue4") +
  labs(title = paste("Occurences per County - by Simpson Index"),
     x = "County",
     y = "Count",
     fill = "S-W Index")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

grid.arrange(count_biodiv_top_prov_barplot, shannon_wiener_top_prov_barplot, nrow = 2)
```

  - Finally, visualizing the dominant groups in the most diverse provinces
```{r}
# Order Level -----
ord_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "order")
ord_per_prov_top <- ord_per_prov %>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

order_per_province_shannon <- ggplot(ord_per_prov_top[ord_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = order)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Order (by Shannon-Wiener Index)",
       x = "Province",
       y = "Abundance (Proportion)",
       fill = "Order") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/order_per_province_shannon.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 6)

# Family Level -----
fam_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "family")
fam_per_prov_top <- fam_per_prov%>%
  group_by(stateProvince) %>%
  top_n(8, total_count) %>%
  ungroup()

family_per_province_shannon <- ggplot(fam_per_prov_top[fam_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = family)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Family (by Shannon-Wiener Index)",
       x = "Province",
       y = "Abundance (Proportion)",
       fill = "Family") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/family_per_province_shannon.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 6)

# Species Level -----
spp_per_prov <- process_counts_per_feature(data_vis, "stateProvince", "species")
spp_per_prov_top <- spp_per_prov %>%
  group_by(stateProvince) %>%
  top_n(5, total_count) %>%
  ungroup()

species_per_province_shannon <- ggplot(spp_per_prov_top[spp_per_prov_top$stateProvince %in% prov_biodiversity_top$stateProvince, ],
       aes(x = stateProvince,
           y = total_count,
           fill = species)) +
  geom_bar(position = position_fill(), stat = "identity") +
  labs(title = "Presence per Province by Species (by Shannon-Wiener Index)",
       x = "Province",
       y = "Abundance (Proportion)") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave( "Figures/species_per_province_shannon.png",
  plot = last_plot(),
  device = "png",
  width = 6, height = 6)
```